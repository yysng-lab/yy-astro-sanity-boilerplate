---
import { siteConfig } from "@config/site.config";
import { seoConfig } from "@config/seo.config";
import { geoConfig } from "@config/geo.config";
import { aeoConfig } from "@config/aeo.config";
import { jsonldConfig } from "@config/jsonld.config";
import { businessConfig } from "@config/business.config";
import { schemaConfig } from "@config/schema.config";
import { Fragment } from "astro/jsx-runtime";

const {
  title = siteConfig.defaultTitle,
  description = siteConfig.defaultDescription,
  image = siteConfig.defaultOgImage,
  url = siteConfig.siteUrl
} = Astro.props;

const { jsonld } = Astro.props; // per-page JSON-LD
---

<head>
  <!-- ──────────────────────────────────────────────── -->
  <!-- BASIC META -->
  <!-- ──────────────────────────────────────────────── -->
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- ──────────────────────────────────────────────── -->
  <!-- PRIMARY SEO -->
  <!-- ──────────────────────────────────────────────── -->
  <title>{title}</title>
  <meta name="description" content={description} />
  <meta name="robots" content="index, follow" />
  <link rel="canonical" href={url} />

  <!-- ──────────────────────────────────────────────── -->
  <!-- UI / BRAND META -->
  <!-- ──────────────────────────────────────────────── -->
  <meta name="theme-color" content={siteConfig.themeColor || "#ffffff"} />

  <!-- ──────────────────────────────────────────────── -->
  <!-- OPEN GRAPH -->
  <!-- ──────────────────────────────────────────────── -->
  <meta property="og:type" content="website" />
  <meta property="og:title" content={title} />
  <meta property="og:description" content={description} />
  <meta property="og:image" content={image} />
  <meta property="og:url" content={url} />

  <!-- ──────────────────────────────────────────────── -->
  <!-- TWITTER CARD -->
  <!-- ──────────────────────────────────────────────── -->
  <meta name="twitter:card" content="summary_large_image" />
  <meta name="twitter:title" content={title} />
  <meta name="twitter:description" content={description} />
  <meta name="twitter:image" content={image} />

  <!-- ──────────────────────────────────────────────── -->
  <!-- GEO TAGS (optional) -->
  <!-- ──────────────────────────────────────────────── -->
  {geoConfig.enabled && (
    <Fragment>
      <meta name="geo.region" content={geoConfig.region} />
      <meta name="geo.placename" content={geoConfig.placename} />
      <meta name="geo.position" content={geoConfig.position} />
      <meta name="ICBM" content={`${geoConfig.latitude}, ${geoConfig.longitude}`} />
    </Fragment>
  )}

  <!-- ──────────────────────────────────────────────── -->
  <!-- GLOBAL JSON-LD (config-driven) -->
  <!-- ──────────────────────────────────────────────── -->
  {
    Object.entries(jsonldConfig)
      .filter(([_, value]) => value.enabled)
      .map(([_, value]) => (
        <script type="application/ld+json">
          {JSON.stringify(value.schema)}
        </script>
      ))
  }

  <!-- ──────────────────────────────────────────────── -->
  <!-- BUSINESS SCHEMAS (Organization / LocalBusiness) -->
  <!-- ──────────────────────────────────────────────── -->
  {
    Object.entries(businessConfig)
      .filter(([_, cfg]) => cfg.enabled)
      .map(([_, cfg]) => (
        <script type="application/ld+json">
          {JSON.stringify(cfg.schema)}
        </script>
      ))
  }

  <!-- ──────────────────────────────────────────────── -->
  <!-- BREADCRUMBLIST SCHEMA -->
  <!-- ──────────────────────────────────────────────── -->
  {schemaConfig.breadcrumbs.enabled && (
    <script type="application/ld+json">
      {JSON.stringify({
        "@context": "https://schema.org",
        "@type": "BreadcrumbList",
        "itemListElement": schemaConfig.breadcrumbs.items.map((item, index) => ({
          "@type": "ListItem",
          "position": index + 1,
          "name": item.name,
          "item": item.url
        }))
      })}
    </script>
  )}

  <!-- ──────────────────────────────────────────────── -->
  <!-- FAQPAGE SCHEMA -->
  <!-- ──────────────────────────────────────────────── -->
  {schemaConfig.faq.enabled && (
    <script type="application/ld+json">
      {JSON.stringify({
        "@context": "https://schema.org",
        "@type": "FAQPage",
        "mainEntity": schemaConfig.faq.questions.map(q => ({
          "@type": "Question",
          "name": q.question,
          "acceptedAnswer": {
            "@type": "Answer",
            "text": q.answer
          }
        }))
      })}
    </script>
  )}

  <!-- ──────────────────────────────────────────────── -->
  <!-- PER-PAGE JSON-LD (array or single object) -->
  <!-- ──────────────────────────────────────────────── -->
  {
    Array.isArray(jsonld)
      ? jsonld.map((schema) => (
          <script type="application/ld+json">
            {JSON.stringify(schema)}
          </script>
        ))
      : jsonld && (
          <script type="application/ld+json">
            {JSON.stringify(jsonld)}
          </script>
        )
  }

  <!-- ──────────────────────────────────────────────── -->
  <!-- AEO SEARCHACTION SCHEMA -->
  <!-- ──────────────────────────────────────────────── -->
  {aeoConfig.enableSearchAction && (
    <script type="application/ld+json">
      {JSON.stringify({
        "@context": "https://schema.org",
        "@type": "WebSite",
        "url": siteConfig.siteUrl,
        "potentialAction": {
          "@type": "SearchAction",
          "target": `${siteConfig.siteUrl}${aeoConfig.searchUrl}`,
          "query-input": "required name=search_term_string"
        }
      })}
    </script>
  )}

  <!-- ──────────────────────────────────────────────── -->
  <!-- EXTRA SEO (from config overrides) -->
  <!-- ──────────────────────────────────────────────── -->
  {seoConfig.extraMetas}

  <!-- ──────────────────────────────────────────────── -->
  <!-- EXTENSION SLOT -->
  <!-- ──────────────────────────────────────────────── -->
  <slot name="head-end" />
</head>
